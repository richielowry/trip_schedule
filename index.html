<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Lord Lowry Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg: #f3f4f6;
  --card: #ffffff;
  --trip: #1d4ed8;
  --event: #15803d;
  --holiday: #b45309;
  --text: #111827;
  --muted: #6b7280;
  --shadow: 0 4px 12px rgba(0,0,0,0.06);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  padding: 20px 14px 60px;
  color: var(--text);
}

h1 {
  text-align: center;
  font-weight: 700;
  margin-bottom: 25px;
}

.table-header {
  display: grid;
  grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  padding: 0 6px 8px 6px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
}

.row {
  display: grid;
  grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr;
  align-items: center;
  font-size: 14px;
}

.title {
  font-weight: 600;
}

.trip {
  color: var(--trip);
  font-size: 15px;
}

.event {
  color: var(--event);
}

.holiday {
  color: var(--holiday);
}

.countdown {
  font-weight: 600;
}
</style>
</head>
<body>

<h1>Lord Lowry</h1>

<div class="table-header">
  <div>Item</div>
  <div>Date</div>
  <div>C'down</div>
  <div>Duration</div>
</div>

<div id="events"></div>

<script>
const ICS_URL = "https://calendar.google.com/calendar/ical/reggmyster%40gmail.com/private-98c5d3a6db4b47b17c7a083cc465a659/basic.ics";

function unfoldICS(text) {
  return text.replace(/\r?\n[ \t]/g, "");
}

function parseDate(value) {
  const datePart = value.substring(0,8);
  return new Date(
    parseInt(datePart.substring(0,4)),
    parseInt(datePart.substring(4,6)) - 1,
    parseInt(datePart.substring(6,8))
  );
}

function adjustEndDate(start, endRaw) {
  if (!endRaw) return start;
  const end = parseDate(endRaw);
  if (end > start) end.setDate(end.getDate() - 1);
  return end;
}

function getNextYearlyOccurrence(originalDate) {
  const now = new Date();
  let next = new Date(now.getFullYear(), originalDate.getMonth(), originalDate.getDate());

  if (next < now) {
    next = new Date(now.getFullYear() + 1, originalDate.getMonth(), originalDate.getDate());
  }

  return next;
}

function parseCalendar(icsText) {
  const items = [];
  const data = unfoldICS(icsText);
  const blocks = data.split("BEGIN:VEVENT");

  blocks.forEach(block => {
    const summaryMatch = block.match(/SUMMARY:(.+)/);
    const startMatch = block.match(/DTSTART[^:]*:(.+)/);
    const endMatch = block.match(/DTEND[^:]*:(.+)/);
    const rruleMatch = block.match(/RRULE:(.+)/);

    if (!summaryMatch || !startMatch) return;

    const rawTitle = summaryMatch[1].trim();
    const lower = rawTitle.toLowerCase();

    let type = null;
    if (lower.includes("trip")) type = "trip";
    if (lower.includes("event")) type = "event";

    if (!type) return;

    const originalStart = parseDate(startMatch[1]);
    let startDate = originalStart;
    let endDate;

    // Handle yearly recurring events
    if (rruleMatch && rruleMatch[1].includes("FREQ=YEARLY")) {
      startDate = getNextYearlyOccurrence(originalStart);
      endDate = startDate;
    } else {
      endDate = adjustEndDate(startDate, endMatch ? endMatch[1] : null);
    }

    items.push({
      type,
      title: rawTitle.replace(/trip|event/i,"").trim(),
      start: startDate,
      end: endDate
    });
  });

  return items;
}

function daysBetween(a,b) {
  return Math.ceil((b - a)/(1000*60*60*24));
}

function overlaps(trip, holidayDate) {
  return holidayDate >= trip.start && holidayDate <= trip.end;
}

async function fetchData() {
  const proxy = "https://api.allorigins.win/raw?url=";
  const calRes = await fetch(proxy + encodeURIComponent(ICS_URL));
  const calText = await calRes.text();
  const calendarItems = parseCalendar(calText);

  const year = new Date().getFullYear();
  const holidayRes = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/IE`);
  const holidays = await holidayRes.json();

  return { calendarItems, holidays };
}

function render(data) {
  const container = document.getElementById("events");
  container.innerHTML = "";

  const now = new Date();
  const futureLimit = new Date();
  futureLimit.setMonth(now.getMonth() + 12);

  let combined = [];
  const tripsOnly = data.calendarItems.filter(e => e.type==="trip");

  data.calendarItems.forEach(e => {
    if (e.start >= now && e.start <= futureLimit) {
      combined.push(e);
    }
  });

  data.holidays.forEach(h => {
    const date = new Date(h.date);
    if (date >= now && date <= futureLimit) {
      const conflict = tripsOnly.some(t => overlaps(t,date));
      if (!conflict) {
        combined.push({
          type:"holiday",
          title: h.name,
          start: date,
          end: date
        });
      }
    }
  });

  combined.sort((a,b)=>a.start - b.start);

  combined.forEach(e=>{
    const card = document.createElement("div");
    card.className="card";

    const row = document.createElement("div");
    row.className="row";

    const title = document.createElement("div");
    title.className="title "+e.type;

    if (e.type==="trip") title.textContent = "‚úàÔ∏è " + e.title;
    else if (e.type==="event") title.textContent = "üéÇ " + e.title;
    else title.textContent = "üáÆüá™ " + e.title;

    const date = document.createElement("div");

    if (e.start.getTime() !== e.end.getTime()) {
      date.textContent =
        e.start.toDateString().slice(4,10) +
        " ‚Äì " +
        e.end.toDateString().slice(4,10);
    } else {
      date.textContent =
        e.start.toDateString().slice(4,10);
    }

    const countdown = document.createElement("div");
    countdown.className="countdown";
    countdown.textContent =
      daysBetween(now,e.start)+"d";

    const duration = document.createElement("div");
    if (e.type==="trip") {
      duration.textContent =
        (daysBetween(e.start,e.end)+1)+"d";
    } else {
      duration.textContent = "-";
    }

    row.appendChild(title);
    row.appendChild(date);
    row.appendChild(countdown);
    row.appendChild(duration);

    card.appendChild(row);
    container.appendChild(card);
  });
}

fetchData().then(render);
</script>

</body>
</html>
