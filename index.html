<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Travel Planner</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d4ed8">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root {
  --bg:#f7f8fb;
  --card:#ffffff;
  --trip:#1d4ed8;
  --event:#6b7280;
  --ongoing:#059669;
  --holiday:#b45309;
  --muted:#6b7280;
}

body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
}

.container {
  max-width:520px;
  margin:auto;
  padding:16px;
}

/* HERO */
.hero {
  background:var(--trip);
  color:white;
  padding:18px;
  border-radius:16px;
  margin-bottom:18px;
}

.hero h2 {
  margin:0 0 6px;
  font-size:18px;
}

.hero small { opacity:0.9; }

/* Cards */
.card {
  background:var(--card);
  padding:14px;
  border-radius:12px;
  margin-bottom:10px;
  border-left:4px solid var(--event);
}

.card.trip { border-left-color:var(--trip); }
.card.event { border-left-color:var(--event); }
.card.ongoing { border-left-color:var(--ongoing); }

.title {
  font-weight:600;
  display:flex;
  justify-content:space-between;
}

.meta {
  font-size:13px;
  color:var(--muted);
  margin-top:4px;
}

.month {
  margin:18px 0 8px;
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
}

.holiday {
  background:#fff7ed;
  color:var(--holiday);
  font-size:13px;
  padding:8px 12px;
  border-radius:10px;
  margin-bottom:6px;
  display:flex;
  justify-content:space-between;
}

.loading { text-align:center; margin-top:40px; }
</style>
</head>
<body>

<div class="container">
  <div id="hero"></div>
  <div id="content" class="loading">Loading...</div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

const CALENDAR_ID = "YOUR_CALENDAR_ID";
const API_KEY = "YOUR_API_KEY";

const today = new Date();
today.setHours(0,0,0,0);

const countryMap = {
  ireland:"ðŸ‡®ðŸ‡ª",
  spain:"ðŸ‡ªðŸ‡¸",
  portugal:"ðŸ‡µðŸ‡¹",
  france:"ðŸ‡«ðŸ‡·",
  italy:"ðŸ‡®ðŸ‡¹",
  germany:"ðŸ‡©ðŸ‡ª",
  poland:"ðŸ‡µðŸ‡±",
  uk:"ðŸ‡¬ðŸ‡§",
  london:"ðŸ‡¬ðŸ‡§",
  usa:"ðŸ‡ºðŸ‡¸",
  "new york":"ðŸ‡ºðŸ‡¸"
};

function getFlag(title){
  const t = title.toLowerCase();
  for (const key in countryMap){
    if(t.includes(key)) return countryMap[key];
  }
  return "ðŸŒ";
}

function formatDate(d){
  return d.toLocaleDateString("en-IE",{day:"numeric",month:"short"});
}

function daysUntil(d){
  return Math.floor((d - today)/(1000*60*60*24));
}

function isOngoing(s,e){
  return today>=s && today<=e;
}

async function fetchCalendar(){
  const timeMin = today.toISOString();
  const timeMax = new Date(today.getFullYear()+1, today.getMonth(), today.getDate()).toISOString();

  const url =
    `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events`+
    `?key=${API_KEY}`+
    `&timeMin=${timeMin}`+
    `&timeMax=${timeMax}`+
    `&singleEvents=true&orderBy=startTime`;

  const res = await fetch(url);
  if(!res.ok) throw new Error("Calendar failed");

  const data = await res.json();
  return data.items;
}

async function fetchHolidays(){
  const year = today.getFullYear();
  const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/IE`);
  return res.json();
}

async function init(){
  const container = document.getElementById("content");

  try{
    const [events, holidays] = await Promise.all([
      fetchCalendar(),
      fetchHolidays()
    ]);

    let items=[];

    events.forEach(ev=>{
      const title = ev.summary || "";
      const lower = title.toLowerCase();

      if(!lower.includes("trip") && !lower.includes("event")) return;

      const start = new Date(ev.start.date || ev.start.dateTime);
      const end = new Date(ev.end.date || ev.end.dateTime || start);
      end.setDate(end.getDate()-1);

      items.push({title,start,end,type:lower.includes("trip")?"trip":"event"});
    });

    holidays.forEach(h=>{
      const date = new Date(h.date);
      if(date>=today)
        items.push({title:"ðŸ‡®ðŸ‡ª "+h.localName,start:date,end:date,type:"holiday"});
    });

    items.sort((a,b)=>a.start-b.start);

    const nextTrip = items.find(e=>e.type==="trip" && e.start>=today);

    if(nextTrip){
      document.getElementById("hero").innerHTML=`
        <div class="hero">
          <h2>${getFlag(nextTrip.title)} ${nextTrip.title}</h2>
          <small>${formatDate(nextTrip.start)} â€“ ${formatDate(nextTrip.end)}
          â€¢ ${daysUntil(nextTrip.start)} days</small>
        </div>`;
    }

    container.innerHTML="";
    let currentMonth="";

    items.forEach(e=>{
      const month=e.start.toLocaleString("en-IE",{month:"long",year:"numeric"});
      if(month!==currentMonth){
        currentMonth=month;
        container.innerHTML+=`<div class="month">${month}</div>`;
      }

      if(e.type==="holiday"){
        container.innerHTML+=`
          <div class="holiday">
            <span>${e.title}</span>
            <span>${formatDate(e.start)}</span>
          </div>`;
        return;
      }

      container.innerHTML+=`
        <div class="card ${e.type} ${isOngoing(e.start,e.end)?"ongoing":""}">
          <div class="title">
            ${getFlag(e.title)} ${e.title}
            <span>${daysUntil(e.start)}d</span>
          </div>
          <div class="meta">
            ${formatDate(e.start)} â€“ ${formatDate(e.end)}
          </div>
        </div>`;
    });

  }catch(err){
    container.innerHTML="Unable to load planner.";
  }
}

init();
</script>
</body>
</html>
